{% extends "base.html" %}
{% load humanize %}
{% load custom_filters %}
{% load static %}

{% block title %}Sales Receipt - #{{ sale.id }}{% endblock %}

{% block content %}

<style>
.receipt-container {
    max-width: 650px;
    margin: 2rem auto;
    padding: 2rem;
    background: #ffffff;
    color: #000000;
    font-family: Arial, Helvetica, sans-serif;
    border: 3px solid #000;
}

/* HEADER */
.receipt-header h1 {
    font-size: 32px;
    font-weight: 900;
    margin-bottom: 10px;
}

.receipt-header p {
    font-size: 18px;
    font-weight: 600;
}

/* DIVIDERS */
.receipt-divider {
    border-top: 3px solid #000;
    margin: 20px 0;
}

/* META INFO */
.info-grid {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 10px 20px;
    font-size: 20px;
    font-weight: 700;
}

/* TABLE */
.receipt-items h3 {
    font-size: 24px;
    margin-bottom: 15px;
}

.receipt-items table {
    width: 100%;
    border-collapse: collapse;
}

.receipt-items th {
    font-size: 20px;
    border-bottom: 3px solid #000;
    padding: 10px 0;
    text-align: left;
}

.receipt-items td {
    font-size: 22px;   /* ðŸ”¥ BIG ITEMS */
    font-weight: 800;  /* ðŸ”¥ BOLD */
    padding: 12px 0;
}

/* SUMMARY */
.receipt-summary {
    margin-top: 20px;
}

.receipt-summary dt,
.receipt-summary dd {
    font-size: 22px;
    font-weight: 700;
}

.grand-total {
    font-size: 30px !important;
    font-weight: 900 !important;
}

/* FOOTER */
.receipt-footer p {
    font-size: 18px;
    font-weight: 600;
}

/* REMOVE SHADOWS FOR PHOTO */
.receipt-container {
    box-shadow: none;
    border-radius: 0;
}

/* PRINT CLEAN */
@media print {
    body {
        background: white !important;
    }
    .receipt-actions {
        display: none !important;
    }
}
</style>
<div class="receipt-container">
    <div class="receipt-header">
        <img src="{% static 'image/itekton-logo.jpg' %}" alt="iTekton Logo" class="receipt-logo">
        <h1>Sales Receipt</h1>
        <p>Oyigbo, Rivers State</p>
        <p>{{ sale.timestamp|date:"M d, Y H:i" }}</p>
    </div>

    <hr class="receipt-divider">

    <div class="receipt-meta">
        <dl class="info-grid">
            <dt>Receipt #:</dt> 
            <dd>{{ sale.id }}</dd>
            <dt>Cashier:</dt> 
            <dd>{{ sale.created_by.get_full_name|default:sale.created_by.username }}</dd>
        </dl>
    </div>

    <hr class="receipt-divider">

    <div class="receipt-items">
        <h3>Items Purchased</h3>
        <table style="width:100%; border-collapse: collapse;">
            <thead>
                <tr>
                    <th align="left">Product</th>
                    <th align="right">Qty</th>
                    <th align="right">Unit Price</th>
                    <th align="right">Subtotal</th>
                </tr>
            </thead>
            <tbody>
                {% for item in sale.items.all %}
                <tr>
                    <td>{{ item.product.name }}</td>
                    <td align="right">{{ item.quantity }}</td>
                    <td align="right">&#8358;{{ item.price|floatformat:2|intcomma }}</td>
                    <td align="right">&#8358;{{ item.subtotal|floatformat:2|intcomma }}</td>
                </tr>
                {% if item.deposit_amount > 0 %}
                <tr>
                    <td colspan="3" align="right"><em>Container Deposit</em></td>
                    <td align="right">&#8358;{{ item.deposit_amount|floatformat:2|intcomma }}</td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>

    <hr class="receipt-divider">

    <div class="receipt-summary">
        <dl class="info-grid">
            <dt>Subtotal:</dt>
            <dd>&#8358;{{ sale.items.all|aggregate_sum:'subtotal'|floatformat:2|intcomma }}</dd>

            {% with deposit_total=sale.items.all|aggregate_sum:'deposit_amount' %}
            {% if deposit_total > 0 %}
            <dt>Deposit Total:</dt>
            <dd>&#8358;{{ deposit_total|floatformat:2|intcomma }}</dd>
            {% endif %}
            {% endwith %}
            
            <dt class="grand-total">Total Paid:</dt>
            <dd class="grand-total">&#8358;{{ sale.total_amount|floatformat:2|intcomma }}</dd>
        </dl>
    </div>

    {% with deposit_total=sale.items.all|aggregate_sum:'deposit_amount' %}
    {% if deposit_total > 0 %}
    <div class="deposit-notice">
        <p><strong>Deposit Information:</strong></p>
        <p>You paid &#8358;{{ deposit_total|floatformat:2|intcomma }} as container deposit. 
        Present this receipt when returning empty containers for your refund.</p>
    </div>
    {% endif %}
    {% endwith %}

    <hr class="receipt-divider">

    <div class="receipt-footer text-center">
        <p>Thank you for your patronage!</p>
        <p class="text-muted small">iTekton Softwares Â© {% now "Y" %}</p>
    </div>

    <div class="receipt-actions no-print">
        <button type="button" class="btn btn-print" onclick="window.print();">
            <i class="fas fa-print"></i> Print Receipt
        </button>
        <a href="{% url 'manage_sales' %}" class="btn btn-back">
            <i class="fas fa-arrow-left"></i> Back to Sales
        </a>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelector('.btn-print').addEventListener('click', function() {
        window.print();
    });
});
</script>

{% endblock %}

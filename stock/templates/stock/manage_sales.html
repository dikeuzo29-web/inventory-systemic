{% extends "base.html" %}
{% load humanize %}
{% load static %}

{% block title %}Manage Sales{% endblock %}


{% block content %}
<form method="post" id="sales-form">
    {% csrf_token %}
    {{ formset.management_form }}

    <div id="formset-container">
        {% for form in formset %}
            <div class="formset-row border rounded p-3 mb-2">
                {{ form.as_p }}
                <button type="button" class="btn btn-danger btn-sm remove-form">Remove</button>
            </div>
        {% endfor %}
    </div>

    <button type="button" class="btn btn-secondary" id="add-form-btn">
        Add another product
    </button>
    <button type="submit" class="btn btn-primary">
        Submit Sale
    </button>
</form>

<hr>


    <script src="{% static 'js/dexie.min.js' %}"></script>
    <script src="{% static 'js/offline_sync.js' %}"></script>
    <script src="{% static 'js/sales.js' %}"></script>

<h2>Recent Sales Transactions</h2>
<div class="table-responsive">
<table class="table table-striped">
    <thead>
        <tr>
            <th>Sale ID</th>
            <th>Items</th>
            <th>Total</th>
            <th>Cashier</th>
            <th>Time</th>
        </tr>
    </thead>
    <tbody>
        {% for sale in sales %}
        <tr>
            <td>{{ sale.id }}</td>
            <td>
                <ul style="margin:0; padding-left:1em;">
                {% for item in sale.items.all %}
                    <li>{{ item.product.name }} Ã— {{ item.quantity }}</li>
                {% endfor %}
                </ul>
            </td>
            <td>â‚¦{{ sale.total_amount|floatformat:2|intcomma }}</td>
            <td>{{ sale.created_by.username }}</td>
            <td>{{ sale.timestamp|naturaltime }}</td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="5">No sales recorded yet.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const addBtn = document.getElementById("add-form-btn");
    const container = document.getElementById("formset-container");
    const totalForms = document.getElementById("id_form-TOTAL_FORMS");

    // âž• Add new form
    addBtn.addEventListener("click", function() {
        const formCount = parseInt(totalForms.value);
        const newForm = container.children[0].cloneNode(true);

        // Reset input values
        newForm.querySelectorAll("input, select").forEach(input => {
            if (input.type === "checkbox") input.checked = false;
            else input.value = "";
        });

        // Update form index (for Django)
        newForm.innerHTML = newForm.innerHTML.replace(/form-(\d)+/g, `form-${formCount}`);
        container.appendChild(newForm);

        totalForms.value = formCount + 1;
    });

    // ðŸ—‘ï¸ Remove form
    document.addEventListener("click", function(e) {
        if (e.target.classList.contains("remove-form")) {
            const rows = document.querySelectorAll(".formset-row");
            if (rows.length > 1) {
                e.target.closest(".formset-row").remove();
                totalForms.value = document.querySelectorAll(".formset-row").length;
            }
        }
    });
});
</script>

{% endblock %}

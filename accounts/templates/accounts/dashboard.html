{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Inventory Dashboard - {{ period|title }}{% endblock %}

{% block extra_head %}

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="{% static 'css/fontawesome.min.css' %}">
<script src="{% static 'js/dexie.min.js' %}"></script>
<script src="{% static 'js/chart.umd.min.js' %}"></script>
<script src="{% static 'js/dashboard.js' %}"></script>
<script src="{% static 'js/offline_logic.js' %}"></script>

<style>
    /* General layout and card enhancements */
    .card {
        border: none;
        border-radius: 0.75rem;
        transition: all 0.3s ease;
    }

    .card:hover {
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .card-header {
        border-top-left-radius: 0.75rem;
        border-top-right-radius: 0.75rem;
        background: linear-gradient(90deg, #e0e7ff, #f3f4f6);
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    /* Filter section */
    .filter-card .form-label {
        font-weight: 500;
        color: #1e293b;
    }

    .filter-card .btn-primary {
        background-color: #3b82f6;
        border-color: #3b82f6;
    }

    .filter-card .btn-primary:hover {
        background-color: #2563eb;
        border-color: #2563eb;
    }

    /* KPI cards */
    .kpi-card {
        background: linear-gradient(135deg, #ffffff, #f9fafb);
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s ease;
    }

    .kpi-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    }

    .kpi-card .kpi-title {
        font-size: 1rem;
        color: #64748b;
        margin-bottom: 0.5rem;
    }

    .kpi-card .kpi-value {
        font-size: 2rem;
        font-weight: 700;
        color: #1e293b;
    }

    /* Table styling */
    .table-hover tbody tr:hover {
        background-color: #f1f5f9;
    }

    .table thead th {
        background-color: #f3f4f6;
        font-weight: 600;
        border-bottom-width: 2px;
        border-color: #e5e7eb;
    }

    .table tfoot th {
        background-color: #f3f4f6;
        font-weight: 700;
    }

    .badge {
        font-size: 0.875rem;
        padding: 0.25em 0.75em;
        font-weight: 500;
    }

    .table-danger {
        --bs-table-bg: #fee2e2;
        --bs-table-border-color: #fecaca;
    }

    .table-warning {
        --bs-table-bg: #fefcbf;
        --bs-table-border-color: #fef08a;
    }

    /* Chart styling */
    .chart-container {
        position: relative;
        height: 400px;
        background: #ffffff;
        border-radius: 0.75rem;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }

    .chart-header {
        margin-bottom: 1rem;
        font-size: 1.25rem;
        color: #1e293b;
    }

    .chart-controls {
        display: flex;
        gap: 0.5rem;
    }

    .chart-btn {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        background: #e5e7eb;
        border: none;
        border-radius: 0.375rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .chart-btn:hover {
        background: #d1d5db;
    }

    .chart-btn.active {
        background: #3b82f6;
        color: #ffffff;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Messages -->
    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
    {% endif %}

    <!-- Filter Section -->
    <div class="card mb-4 shadow-sm filter-card">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-filter me-2 text-primary"></i> Report Filters</h5>
        </div>
        <div class="card-body">
            <form method="get" class="row g-3 align-items-end">
                {% csrf_token %}
                <div class="col-md-4 col-lg-3">
                    <label for="periodSelect" class="form-label">Report Period</label>
                    <select name="period" id="periodSelect" class="form-select">
                        <option value="daily" {% if period == 'daily' %}selected{% endif %}>Daily</option>
                        <option value="weekly" {% if period == 'weekly' %}selected{% endif %}>Weekly</option>
                        <option value="monthly" {% if period == 'monthly' %}selected{% endif %}>Monthly</option>
                        <option value="quarterly" {% if period == 'quarterly' %}selected{% endif %}>Quarterly</option>
                        <option value="custom" {% if period == 'custom' %}selected{% endif %}>Custom Range</option>
                    </select>
                </div>
                <div class="col-md-4 col-lg-3">
                    <label for="startDate" class="form-label">Start Date</label>
                    <input type="date" name="start_date" id="startDate" class="form-control"
                        value="{{ request.GET.start_date }}" {% if period != 'custom' %}disabled{% endif %}>
                </div>
                <div class="col-md-4 col-lg-3">
                    <label for="endDate" class="form-label">End Date</label>
                    <input type="date" name="end_date" id="endDate" class="form-control"
                        value="{{ request.GET.end_date }}" {% if period != 'custom' %}disabled{% endif %}>
                </div>
                <div class="col-md-12 col-lg-3 d-grid">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check me-1"></i> Apply Filters
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-6 col-lg-3">
            <div class="kpi-card">
                <div class="kpi-title">Total Revenue</div>
                <div class="kpi-value text-success">₦{{ total_revenue|default:0|floatformat:2|intcomma }}</div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3">
            <div class="kpi-card">
                <div class="kpi-title">Units Sold</div>
                <div class="kpi-value text-primary">{{ total_quantity|default:0|intcomma }}</div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3">
            <div class="kpi-card">
                <div class="kpi-title">Transactions</div>
                <div class="kpi-value text-info">{{ transactions_count|default:0|intcomma }}</div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3">
            <div class="kpi-card">
                <div class="kpi-title">Inventory Value</div>
                <div class="kpi-value text-secondary">₦{{ total_inventory_value|default:0|floatformat:2|intcomma }}
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="row g-4 mb-4">
        <!-- Sales Trend Chart -->
        <div class="col-xl-8">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2 text-info"></i> Sales & Revenue Trend</h5>
                    <div class="chart-controls">
                        <button class="chart-btn active" data-range="7">7D</button>
                        <button class="chart-btn" data-range="30">30D</button>
                        <button class="chart-btn" data-range="90">90D</button>
                        <button class="chart-btn" data-range="365">1Y</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="salesTrendChart" aria-label="Sales and revenue trend over time"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventory Value by Category -->
        <div class="col-xl-4">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-pie-chart me-2 text-warning"></i> Inventory Value by Category</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="inventoryChart" aria-label="Inventory value distribution by category"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Inventory Summary & Top Selling -->
    <div class="row g-4">
        <div class="col-xl-8">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-boxes me-2 text-success"></i> Current Inventory Status</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th class="text-end">Stock Level</th>
                                    <th>Category</th>
                                    <th class="text-end">Reorder Level</th>
                                    <th>Status</th>
                                    <th class="text-end">Value</th>
                                    <th>Last Updated</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for product in current_stock %}
                                <tr
                                    class="{% if product.quantity <= 0 %}table-danger{% elif product.quantity <= product.reorder_level %}table-warning{% endif %}">
                                    <td>{{ product.name }}</td>
                                    <td class="text-end">{{ product.quantity|intcomma }}</td>
                                    <td>{{ product.category|default:"-" }}</td>
                                    <td class="text-end">{{ product.reorder_level|intcomma }}</td>
                                    <td>
                                        <span
                                            class="badge {% if product.quantity <= 0 %}bg-danger{% elif product.quantity <= product.reorder_level %}bg-warning text-dark{% else %}bg-success{% endif %}">
                                            {{ product.stock_status }}
                                        </span>
                                    </td>
                                    <td class="text-end">₦{{ product.inventory_value|floatformat:2|intcomma }}</td>
                                    <td>{{ product.last_updated|date:"M d, Y H:i" }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center text-muted py-4">No inventory items found. Add
                                        products to get started.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-4">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-trophy me-2 text-danger"></i> Top Selling Products</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="topProductsChart" aria-label="Top selling products"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>


<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Date input toggling

        // Debug checks
        console.log('Chart.js loaded:', typeof Chart !== 'undefined');
        console.log('Canvas elements:', {
            sales: document.getElementById('salesTrendChart'),
            inventory: document.getElementById('inventoryChart'),
            topProducts: document.getElementById('topProductsChart')
        })

        const periodSelect = document.getElementById('periodSelect');
        const startDate = document.getElementById('startDate');
        const endDate = document.getElementById('endDate');

        function toggleDateInputs() {
            const isCustom = periodSelect.value === 'custom';
            startDate.disabled = !isCustom;
            endDate.disabled = !isCustom;
            if (!isCustom) {
                startDate.value = '';
                endDate.value = '';
            }
        }
        periodSelect.addEventListener('change', toggleDateInputs);
        toggleDateInputs();

        // Chart initialization
        try {
            const chartData = JSON.parse('{{ chart_data|escapejs }}');
            if (!chartData) throw new Error('Chart data is empty');

            // Sales Trend Chart (Dual-axis line)
            const salesCtx = document.getElementById('salesTrendChart').getContext('2d');
            new Chart(salesCtx, {
                type: 'line',
                data: {
                    labels: chartData.sales_trend.dates,
                    datasets: [{
                        label: 'Revenue (N)',
                        data: chartData.sales_trend.revenues,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        yAxisID: 'yRevenue',
                        fill: true,
                        tension: 0.3
                    }, {
                        label: 'Units Sold',
                        data: chartData.sales_trend.quantities,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        yAxisID: 'yQuantity',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        yRevenue: {
                            type: 'linear',
                            position: 'left',
                            title: { display: true, text: 'Revenue (N)' },
                            ticks: { callback: value => 'N' + value.toLocaleString() }
                        },
                        yQuantity: {
                            type: 'linear',
                            position: 'right',
                            title: { display: true, text: 'Units' },
                            grid: { drawOnChartArea: false }
                        }
                    },
                    plugins: {
                        tooltip: { mode: 'index', intersect: false },
                        legend: { position: 'top' }
                    }
                }
            });

            // Inventory Value by Category (Doughnut with hover effects)
            const inventoryCtx = document.getElementById('inventoryChart').getContext('2d');
            new Chart(inventoryCtx, {
                type: 'doughnut',
                data: {
                    labels: chartData.inventory_by_category.labels,
                    datasets: [{
                        data: chartData.inventory_by_category.values,
                        backgroundColor: ['#ef4444', '#3b82f6', '#f59e0b', '#10b981', '#8b5cf6', '#ec4899'],
                        borderColor: '#ffffff',
                        borderWidth: 2,
                        hoverOffset: 20
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { font: { size: 14 } } },
                        tooltip: { callbacks: { label: ctx => `${ctx.label}: N${ctx.raw.toLocaleString()}` } }
                    }
                }
            });

            // Top Selling Products (Horizontal bar with revenue)
            const topProductsCtx = document.getElementById('topProductsChart').getContext('2d');
            new Chart(topProductsCtx, {
                type: 'bar',
                data: {
                    labels: chartData.top_products.labels,
                    datasets: [{
                        label: 'Units Sold',
                        data: chartData.top_products.sales,
                        backgroundColor: '#ef4444',
                        borderColor: '#dc2626',
                        borderWidth: 1
                    }, {
                        label: 'Revenue (N)',
                        data: chartData.top_products.revenues,
                        backgroundColor: 'rgba(239, 68, 68, 0.5)',
                        borderColor: 'rgba(220, 38, 38, 0.8)',
                        borderWidth: 1,
                        type: 'line'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { beginAtZero: true, title: { display: true, text: 'Units & Revenue' } }
                    },
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: ctx => {
                                    const label = ctx.dataset.label || '';
                                    return `${label}: ${ctx.raw.toLocaleString()} ${label.includes('Revenue') ? 'N' : 'units'}`;
                                }
                            }
                        }
                    }
                }
            });
            function renderCharts(data) {
                const charts = Chart.instances;
                charts.forEach(chart => {
                    if (chart.canvas.id === 'salesTrendChart') {
                        chart.data.labels = data.sales_trend.dates;
                        chart.data.datasets[0].data = data.sales_trend.revenues;
                        chart.data.datasets[1].data = data.sales_trend.quantities;
                    } else if (chart.canvas.id === 'inventoryChart') {
                        chart.data.labels = data.inventory_by_category.labels;
                        chart.data.datasets[0].data = data.inventory_by_category.values;
                    } else if (chart.canvas.id === 'topProductsChart') {
                        chart.data.labels = data.top_products.labels;
                        chart.data.datasets[0].data = data.top_products.sales;
                        chart.data.datasets[1].data = data.top_products.revenues;
                    }
                    chart.update();
                });
            }

            // Real-time updates (every 5 minutes) with offline fallback
            function updateCharts() {
                if (!navigator.onLine) {
                    console.log("Offline mode: loading cached chart data.");
                    db.chartCache.get("latest").then(cached => {
                        if (cached && cached.data) {
                            renderCharts(cached.data); // custom function to update charts
                        }
                    });
                    return;
                }

                fetch('/api/chart-data/?period=' + periodSelect.value + '&start_date=' + startDate.value + '&end_date=' + endDate.value)
                    .then(response => response.json())
                    .then(data => {
                        // Save to Dexie for offline use
                        db.chartCache.put({ key: "latest", data });

                        renderCharts(data);
                    })
                    .catch(error => console.error('Error updating charts:', error));
            }

            setInterval(updateCharts, 5 * 60 * 1000);
            updateCharts();


            // Date range buttons for Sales Trend
            document.querySelectorAll('.chart-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    document.querySelectorAll('.chart-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    const range = this.getAttribute('data-range');
                    fetch(`/api/chart-data/?period=custom&range=${range}&start_date=${startDate.value}&end_date=${endDate.value}`)
                        .then(response => response.json())
                        .then(data => {
                            const chart = Chart.getChart('salesTrendChart');
                            chart.data.labels = data.sales_trend.dates;
                            chart.data.datasets[0].data = data.sales_trend.revenues;
                            chart.data.datasets[1].data = data.sales_trend.quantities;
                            chart.update();
                        });
                });
            });

        } catch (error) {
            console.error('Chart initialization error:', error);
            const containers = document.querySelectorAll('.chart-container');
            containers.forEach(container => {
                const ctx = container.querySelector('canvas').getContext('2d');
                ctx.font = "1.25rem Arial";
                ctx.fillStyle = "#64748b";
                ctx.textAlign = "center";
                ctx.fillText("Error loading chart data", container.offsetWidth / 2, container.offsetHeight / 2);
            });
        }
    });
</script>
{% endblock %}
{% block footer %}
<div class="text-center text-muted mt-4">
    &copy; {{ current_year }} Inventory Management System. All rights reserved.
</div>
{% endblock %}